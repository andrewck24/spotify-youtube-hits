# Feature Specification: 瀏覽器導航與資料快取

**Feature Branch**: `004-routing-and-caching`
**Created**: 2025-11-14
**Status**: Draft
**Input**: User description: "讓使用者可以使用瀏覽器上一頁下一頁功能，在下述頁面進行跳轉：首頁（顯示歌手推薦，點即可直接跳至歌手資訊頁） -> 搜尋結果頁 -> 歌手資訊頁 -> 歌曲資訊頁"

## Clarifications

### Session 2025-11-14

- Q: Track 頁面的 URL 結構？ → A: 使用扁平結構 `/track/:trackId`，因為 Spotify track API 回應已包含完整 artist 資訊
- Q: API 錯誤時的處理行為？ → A: 保持 URL 不變，使用統一錯誤元件。可重試錯誤（網路、500、429）提供重試+返回選項；不可重試錯誤（404）僅提供返回選項
- Q: 首頁推薦歌手的選擇方式？ → A: 直接使用預定義的 8 位高人氣歌手清單（Gorillaz, Billie Eilish, The Weeknd, Bruno Mars, Ariana Grande, Taylor Swift, Drake, Adele），無需動態計算
- Q: 快速連續導航的請求處理？ → A: 使用 AbortController 取消所有 pending API requests，只保留最新的導航請求
- Q: Track 頁面的 artist 資料載入？ → A: 從 track API 獲取 artist ID 後額外請求完整 artist 資訊。UI 採用漸進式載入：先顯示 track 中的部分資料+skeleton，待完整資料回傳後更新

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本頁面導航 (Priority: P1)

使用者能夠在應用程式的不同頁面之間進行導航（首頁、搜尋結果頁、歌手資訊頁、歌曲資訊頁），並且能夠使用瀏覽器的「上一頁」和「下一頁」按鈕在訪問過的頁面之間跳轉。

**Why this priority**: 這是核心功能，沒有正確的導航機制，使用者體驗會非常差。瀏覽器歷史導航是現代網頁應用的基本期望，也是本功能的主要需求。

**Independent Test**: 可以透過以下操作獨立測試：開啟應用程式 → 點擊歌手 → 點擊歌曲 → 按瀏覽器「上一頁」按鈕 → 確認返回歌手資訊頁 → 再按「下一頁」→ 確認前進到歌曲資訊頁。此測試驗證核心導航功能完全運作。

**Acceptance Scenarios**:

1. **Given** 使用者在歌手資訊頁，**When** 使用者點擊某首歌曲，**Then** 應用程式導航到該歌曲的資訊頁，且瀏覽器 URL 更新為對應的歌曲 URL
2. **Given** 使用者在歌曲資訊頁，**When** 使用者點擊瀏覽器的「上一頁」按鈕，**Then** 應用程式返回到歌手資訊頁，且顯示正確的歌手資料
3. **Given** 使用者剛按了上一頁返回歌手資訊頁，**When** 使用者點擊瀏覽器的「下一頁」按鈕，**Then** 應用程式前進到剛才的歌曲資訊頁，且顯示正確的歌曲資料
4. **Given** 使用者在搜尋結果頁，**When** 使用者點擊某位歌手，**Then** 應用程式導航到該歌手的資訊頁，且 URL 包含該歌手的 ID

---

### User Story 2 - 首頁歌手推薦 (Priority: P2)

使用者開啟應用程式時，會看到一個首頁，上面顯示熱門歌手的推薦列表。使用者可以直接點擊任一推薦歌手，快速跳轉到該歌手的資訊頁。

**Why this priority**: 首頁提供更好的使用者體驗，讓使用者不需要先搜尋就能探索內容。這改善了應用程式的可發現性，但不是核心導航功能的必要條件，因此優先級較 P1 低。

**Independent Test**: 可以透過以下操作獨立測試：開啟應用程式 → 確認看到首頁 → 確認顯示多位歌手推薦 → 點擊任一歌手 → 確認導航到該歌手的資訊頁。此測試完全獨立於搜尋功能和歌曲瀏覽功能。

**Acceptance Scenarios**:

1. **Given** 使用者開啟應用程式（首次訪問或清空瀏覽歷史），**When** 頁面載入完成，**Then** 使用者看到首頁，上面顯示 5-10 位熱門歌手的列表
2. **Given** 使用者在首頁，**When** 使用者點擊任一推薦歌手，**Then** 應用程式導航到該歌手的資訊頁，顯示該歌手的詳細資訊和歌曲列表
3. **Given** 使用者從首頁進入某歌手資訊頁，**When** 使用者點擊瀏覽器「上一頁」按鈕，**Then** 應用程式返回首頁，仍顯示相同的推薦歌手列表
4. **Given** 使用者在首頁，**When** 使用者觀察推薦歌手列表，**Then** 列表中的歌手按人氣度由高到低排序

---

### User Story 3 - 深度連結支援 (Priority: P3)

使用者可以直接透過 URL 訪問特定頁面（例如：直接開啟某歌手或某歌曲的 URL），應用程式會自動載入對應的內容，而不需要從首頁開始導航。

**Why this priority**: 深度連結提升使用者體驗，讓使用者可以分享連結、收藏特定頁面，或從外部來源直接進入。這是現代網頁應用的標準功能，但在 MVP 階段優先級低於基本導航和首頁功能。

**Independent Test**: 可以透過以下操作獨立測試：直接在瀏覽器輸入歌手資訊頁的 URL（例如：`/artist/123`）→ 確認應用程式載入並顯示該歌手的資訊 → 再直接輸入歌曲資訊頁的 URL（例如：`/track/456`）→ 確認應用程式載入並顯示該歌曲的資訊。此測試完全不依賴首頁或導航按鈕。

**Acceptance Scenarios**:

1. **Given** 使用者直接在瀏覽器輸入特定歌手的 URL（例如 `/artist/3WrFJ7ztbogyGnTHbHJFl2`），**When** 按下 Enter，**Then** 應用程式載入該歌手的資訊頁，顯示該歌手的詳細資訊和歌曲列表
2. **Given** 使用者直接在瀏覽器輸入特定歌曲的 URL（例如 `/track/1234567890abcdef`），**When** 按下 Enter，**Then** 應用程式載入該歌曲的資訊頁，先顯示基本資訊與 skeleton UI，待完整資料載入後顯示完整的歌曲與歌手資訊
3. **Given** 使用者在其他地方（例如：電子郵件、社交媒體）取得歌手或歌曲的 URL，**When** 使用者點擊該 URL，**Then** 應用程式開啟並直接顯示對應的內容
4. **Given** 使用者直接訪問搜尋結果頁的 URL（例如 `/search?q=Beatles`），**When** 頁面載入，**Then** 應用程式顯示 "Beatles" 的搜尋結果

---

### User Story 4 - 資料快取 (Priority: P4)

已經獲取過的歌手資訊、歌曲詳情和音樂特徵資料會被快取，當使用者返回之前瀏覽過的頁面時，不需要重新請求相同的資料，提升載入速度和減少 API 呼叫次數。

**Why this priority**: 快取改善效能和使用者體驗，減少不必要的 API 請求，但不是功能正常運作的必要條件。在基本導航功能完成後實作，可以作為效能優化的獨立增強功能。

**Independent Test**: 可以透過以下操作獨立測試：開啟應用程式 → 瀏覽某歌手頁面（記錄 API 請求次數）→ 瀏覽其他頁面 → 返回同一歌手頁面 → 確認沒有發出新的 API 請求，資料直接從快取讀取。可使用瀏覽器開發者工具的 Network 面板驗證。

**Acceptance Scenarios**:

1. **Given** 使用者已經訪問過某歌手的資訊頁，**When** 使用者導航到其他頁面後再返回該歌手的資訊頁，**Then** 應用程式直接從快取載入歌手資料，不發出新的 API 請求
2. **Given** 使用者已經訪問過某歌曲的資訊頁，**When** 使用者導航離開後再次訪問相同歌曲，**Then** 應用程式直接從快取載入歌曲資料和音樂特徵，不發出新的 API 請求
3. **Given** 快取中已有某歌手的資料，**When** 使用者在當前瀏覽階段（session）中多次訪問該歌手頁面，**Then** 所有後續訪問都使用快取資料，快取命中率達到 90% 以上
4. **Given** 使用者瀏覽應用程式一段時間，訪問了多位歌手和歌曲，**When** 檢查 API 請求記錄，**Then** 相同資源的 API 請求只發生一次，後續都使用快取

---

### Edge Cases

- **不存在的資源 (404)**：使用者直接訪問不存在的歌手或歌曲 URL 時，系統保持當前 URL 不變，顯示統一錯誤元件並附上「返回上一頁」按鈕（不提供重試選項，因為 404 不可重試）
- **網路連線失敗**：當使用者在無網路連線狀態下嘗試訪問未快取的內容時，系統保持 URL 不變，顯示統一錯誤元件，提示網路問題並提供「重試」與「返回上一頁」兩個選項
- **API 限流 (429)**：當 Spotify API 回傳 rate limit 錯誤時，系統保持 URL 不變，顯示統一錯誤元件，說明請求過於頻繁並提供「重試」與「返回上一頁」選項
- **伺服器錯誤 (500)**：當 Spotify API 回傳伺服器錯誤時，系統保持 URL 不變，顯示統一錯誤元件，說明伺服器暫時無法回應並提供「重試」與「返回上一頁」選項
- **空白搜尋關鍵字**：使用者在搜尋結果頁輸入空白搜尋關鍵字時，系統顯示空結果狀態與提示訊息（例如：「請輸入搜尋關鍵字」），不更新 URL 也不顯示錯誤
- **頁面重新整理**：使用者重新整理頁面時，系統能保持當前狀態，因為 URL 包含所有必要資訊，會基於 URL 重新載入對應內容與快取資料
- **無效的 ID 格式**：當 URL 中的 ID 格式不正確時（例如：`/artist/invalid-id`），系統嘗試發送 API 請求，若 API 回傳 404 則按照「不存在的資源」處理方式顯示錯誤
- **快速連續導航**：使用者快速連續點擊多個連結時，系統使用 AbortController 取消所有 pending 的 API requests，只保留並處理最新的導航目標請求，確保 UI 顯示正確的最終頁面
- **快取持久性**：瀏覽器的「重新整理」按鈕不會清除快取（快取保留在記憶體中），除非使用者手動清除瀏覽器資料或關閉分頁

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 應用程式必須實作四個主要頁面路由：首頁（`/`）、搜尋結果頁（`/search`）、歌手資訊頁（`/artist/:artistId`）、歌曲資訊頁（`/track/:trackId`）
- **FR-002**: 當使用者點擊導航連結時，應用程式必須更新瀏覽器 URL，並將新的 URL 加入瀏覽器歷史記錄
- **FR-003**: 當使用者點擊瀏覽器的「上一頁」或「下一頁」按鈕時，應用程式必須導航到對應的頁面並顯示正確的內容
- **FR-004**: 首頁必須顯示 8 位預定義的高人氣歌手推薦列表（參考 data-model.md 中的 RECOMMENDED_ARTIST_IDS 常數）
- **FR-005**: 搜尋結果頁的 URL 必須包含搜尋關鍵字作為查詢參數（例如：`/search?q=Beatles`）
- **FR-006**: 歌手資訊頁的 URL 必須包含歌手的唯一識別碼（Spotify Artist ID）
- **FR-007**: 歌曲資訊頁的 URL 必須包含歌曲 ID（格式：`/track/:trackId`），無需包含歌手 ID，因為 Spotify track API 回應已包含完整的 artist 資訊
- **FR-008**: 當使用者直接訪問特定頁面的 URL 時（深度連結），應用程式必須能夠解析 URL 並載入對應的內容
- **FR-009**: 應用程式必須在 URL 與應用程式狀態之間保持同步：URL 變更時更新狀態，狀態變更時更新 URL
- **FR-010**: 已經透過 API 獲取的歌手資訊必須被快取，當使用者再次訪問相同歌手時直接使用快取資料
- **FR-011**: 已經透過 API 獲取的歌曲詳情和音樂特徵必須被快取，當使用者再次訪問相同歌曲時直接使用快取資料
- **FR-012**: 當 API 請求失敗或 URL 無效時，應用程式必須保持當前 URL 不變，並使用統一的錯誤元件顯示錯誤訊息。對於可重試的錯誤（網路錯誤、500 伺服器錯誤、429 rate limit），提供「重試」和「返回上一頁」兩個選項；對於不可重試的錯誤（404 資源不存在），僅提供「返回上一頁」選項
- **FR-013**: 當使用者重新整理頁面時，應用程式必須保持當前頁面狀態（基於 URL 重新載入對應內容）
- **FR-014**: 搜尋功能必須在使用者輸入關鍵字後更新 URL，以便搜尋結果可以被分享和收藏
- **FR-015**: 應用程式必須處理快速導航場景（使用者連續快速點擊多個連結），使用 AbortController 取消所有 pending 的 API requests，確保只載入最終目標頁面的內容
- **FR-016**: 當載入 track 頁面時，系統必須採用漸進式載入策略：(1) 立即使用 track API 回應中的部分 artist 資料（name, id）顯示基本資訊並搭配 skeleton UI，(2) 從 artist ID 發送完整的 artist API 請求並快取，(3) 待完整 artist 資料回傳後更新 UI 元件

### Key Entities

- **Route（路由）**: 代表應用程式中的一個頁面，包含 URL 路徑模式、對應的頁面元件、以及 URL 參數定義（例如：`:artistId`、`:trackId`）
- **Navigation State（導航狀態）**: 代表當前使用者所在的頁面位置，包含當前 URL、URL 參數值、查詢參數值，以及瀏覽器歷史堆疊
- **Cache Entry（快取項目）**: 代表一筆快取的 API 回應資料，包含資源識別碼（例如：歌手 ID、歌曲 ID）、資料內容（歌手資訊、歌曲詳情、音樂特徵）、以及快取時間戳記
- **Artist Recommendation（歌手推薦）**: 代表首頁顯示的推薦歌手項目，包含歌手基本資訊（名稱、照片、人氣度）、以及指向該歌手資訊頁的連結
- **Navigation History（導航歷史）**: 代表使用者的瀏覽歷史，由瀏覽器管理，包含訪問過的頁面 URL 序列、當前位置索引、以及前進/後退的可用性狀態

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能夠使用瀏覽器的「上一頁」和「下一頁」按鈕在所有已訪問頁面之間導航，導航準確率 100%
- **SC-002**: 首頁載入時間少於 1 秒（從 URL 輸入到推薦歌手列表顯示完成）
- **SC-003**: 使用者直接訪問任何有效的歌手或歌曲 URL 時，頁面能在 2 秒內完成載入並顯示完整內容
- **SC-004**: 在同一瀏覽階段（session）中，重複訪問相同歌手或歌曲時，快取命中率達到 90% 以上（即 90% 的重複訪問不發出新的 API 請求）
- **SC-005**: 所有頁面的 URL 都是可分享的，其他使用者點擊分享的 URL 能看到相同的內容
- **SC-006**: 使用者重新整理任何頁面時，頁面能保持當前狀態，不會回到首頁或初始狀態
- **SC-007**: 當使用者在 5 秒內快速點擊 10 個不同連結時，應用程式能正確處理並最終顯示最後點擊的頁面內容
- **SC-008**: API 請求次數減少至少 50%（與無快取版本相比），透過快取重複訪問的資料
- **SC-009**: 使用者在歌手資訊頁和歌曲資訊頁之間切換時，頁面切換時間少於 0.5 秒（若資料已快取）
- **SC-010**: 90% 的使用者能夠成功使用瀏覽器導航按鈕返回之前訪問的頁面，無需使用應用程式內的返回按鈕

## Assumptions *(optional)*

1. **首頁推薦來源**: 假設使用預定義的 8 位高人氣歌手清單（Gorillaz, Billie Eilish, The Weeknd, Bruno Mars, Ariana Grande, Taylor Swift, Drake, Adele），無需從 `tracks.json` 動態計算，參考 data-model.md 中的 RECOMMENDED_ARTIST_IDS 常數
2. **路由庫選擇**: 假設使用已安裝的 `react-router-dom` 套件（v7.9.3）實作路由功能
3. **快取實作方式**: 假設使用現有的 Redux 狀態管理來實作快取，已獲取的資料保留在 Redux store 中直到頁面關閉
4. **快取生命週期**: 假設快取資料在當前瀏覽階段（browser session）有效，關閉分頁或瀏覽器後清除
5. **URL 結構設計**: 假設採用扁平路由結構（`/track/:trackId`），因為 Spotify track API 回應已包含完整的 artist 資訊（包括 artists 陣列與各 artist 的 id、name），無需在 URL 中冗餘 artistId。這簡化了 URL 結構並減少了深度連結的複雜度
6. **搜尋頁面路由**: 假設搜尋功能使用查詢參數而非路徑參數（`/search?q=keyword` 而非 `/search/keyword`），符合搜尋頁面的標準做法
7. **錯誤處理**: 假設當 API 請求失敗或 URL 無效時，顯示友善的錯誤訊息並保持在當前頁面，而非導致整個應用程式崩潰
8. **歷史狀態管理**: 假設使用瀏覽器原生的 History API（透過 React Router），不需要額外的狀態管理邏輯
9. **深度連結支援範圍**: 假設所有頁面都支援深度連結，包括搜尋結果頁（透過查詢參數保存搜尋關鍵字）
10. **資料一致性**: 假設在單一瀏覽階段中，歌手和歌曲的資料不會改變，因此不需要實作快取失效或重新驗證機制

## Dependencies *(optional)*

1. **react-router-dom**: 已安裝的路由庫（v7.9.3），用於實作頁面路由和瀏覽器歷史管理
2. **Redux**: 現有的狀態管理系統，用於實作資料快取和狀態同步
3. **本地資料檔案**: `public/data/tracks.json` 必須包含足夠的歌手資料（至少 5-10 位不同歌手），用於產生首頁推薦列表
4. **Spotify API**: 需要穩定的 API 存取權限，用於獲取歌手詳細資訊、歌曲詳情和音樂特徵
5. **現有元件**: 依賴現有的 `ArtistProfile`、`TrackDetail`、`SearchResults` 等元件，這些元件需要能夠從 URL 參數接收資料識別碼

## Out of Scope *(optional)*

1. **伺服器端渲染（SSR）**: 本功能不包含伺服器端渲染或靜態站點生成（SSG），僅實作客戶端路由
2. **SEO 優化**: 不包含針對搜尋引擎的 meta 標籤優化或結構化資料
3. **持久化快取**: 不實作跨瀏覽階段的持久化快取（例如：localStorage、IndexedDB）
4. **快取失效策略**: 不實作自動快取失效或資料重新驗證機制
5. **進階歷史管理**: 不實作自訂的歷史堆疊管理或導航攔截功能
6. **頁面切換動畫**: 不包含頁面切換時的過場動畫或載入動畫
7. **狀態恢復**: 不恢復使用者在頁面上的互動狀態（例如：捲動位置、展開/收合狀態）
8. **離線支援**: 不實作 Service Worker 或離線快取功能
9. **A/B 測試**: 不包含首頁推薦演算法的 A/B 測試或個人化推薦
10. **分析追蹤**: 不包含頁面瀏覽追蹤或使用者行為分析功能
